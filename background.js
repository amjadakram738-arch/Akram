let c=new Map,u=new Map;const p={operatingMode:"auto",sourceLanguage:"auto",targetLanguage:"en",uiLanguage:"en",audioCaptureMethod:"direct",translationEngines:[{name:"google",enabled:!0,priority:1},{name:"libretranslate",enabled:!0,priority:2},{name:"mymemory",enabled:!0,priority:3},{name:"deepl-free",enabled:!1,priority:4},{name:"microsoft",enabled:!0,priority:5},{name:"yandex",enabled:!1,priority:6},{name:"apertium",enabled:!1,priority:7},{name:"argos",enabled:!1,priority:8},{name:"opennmt",enabled:!1,priority:9},{name:"whisper-local",enabled:!1,priority:10}],audioProcessingServer:"webaudio",fontSize:"medium",fontFamily:"sans-serif",textColor:"#FFFFFF",backgroundColor:"rgba(0, 0, 0, 0.7)",backgroundType:"shadowed",opacity:90,position:"bottom",displayMode:"simple",dualLanguage:!1,smartMode:!0,qualityMode:"balanced",gpuAcceleration:!0,maxMemoryMB:100,bufferSize:5,latencyTarget:1e3,localOnlyMode:!1,autoDeleteRecordings:!0,anonymousMode:!0,encryptStorage:!1,passwordProtection:!1,archiveEnabled:!1,interactiveLearning:!1,sentimentAnalysis:!1,smartAlerts:!1,smartAlertKeywords:[],liveStreamingMode:!1,educationalMode:!1,exportFormat:"srt",deviceType:"auto",performanceMode:"balanced",batteryEconomy:!1,offlineMode:!1,offlineModels:[],audioOutputDevice:"default",audioInputDevice:"default",alwaysCaptureMode:!0,multiDeviceRecording:!1,bluetoothLatencyCompensation:100,drmBypassEnabled:!0,systemAudioCapture:!0,fallbackMode:!0,universalSupportMode:!0,whitelistedSites:[],blacklistedSites:[],iframeSupport:!0,notificationsEnabled:!0,failureAlerts:!0,connectionAlerts:!0,enableShortcuts:!0,theme:"auto",maxRetries:3,retryDelay:2e3,autoUpdate:!0,sharingEnabled:!1,ttsEnabled:!1};chrome.runtime.onInstalled.addListener(async e=>{console.log("Video Translator Extension installed:",e.reason),(await chrome.storage.local.get("settings")).settings||(await chrome.storage.local.set({settings:p}),console.log("Default settings initialized")),T(),e.reason==="install"&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:chrome.i18n.getMessage("extensionName"),message:chrome.i18n.getMessage("welcomeMessage")||"Video Translator installed successfully!"})});function T(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"video-translator-toggle",title:chrome.i18n.getMessage("toggleTranslation")||"Toggle Translation",contexts:["all"]}),chrome.contextMenus.create({id:"video-translator-settings",title:chrome.i18n.getMessage("openSettings")||"Open Settings",contexts:["all"]})})}chrome.contextMenus.onClicked.addListener(async(e,t)=>{e.menuItemId==="video-translator-toggle"?h(t.id):e.menuItemId==="video-translator-settings"&&chrome.runtime.openOptionsPage()});chrome.commands.onCommand.addListener(async e=>{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});e==="toggle-translation"?h(t.id):e==="increase-font"?g(t.id,"increase"):e==="decrease-font"&&g(t.id,"decrease")});async function h(e){c.get(e)?(c.delete(e),await chrome.tabs.sendMessage(e,{action:"stopTranslation"}),console.log("Translation stopped for tab:",e)):(c.set(e,!0),await chrome.tabs.sendMessage(e,{action:"startTranslation"}),console.log("Translation started for tab:",e))}async function g(e,t){await chrome.tabs.sendMessage(e,{action:"adjustFontSize",direction:t})}chrome.runtime.onMessage.addListener((e,t,a)=>(console.log("Background received message:",e),(async()=>{try{switch(e.action){case"getSettings":const o=await l();a({success:!0,settings:o});break;case"saveSettings":await x(e.settings),a({success:!0});break;case"translateText":const r=await S(e.text,e.sourceLang,e.targetLang);a({success:!0,translation:r});break;case"detectLanguage":const n=await y(e.text);a({success:!0,language:n});break;case"processAudio":const s=await E(e.audioData,e.language);a({success:!0,transcript:s});break;case"startAudioCapture":await L(t.tab.id,e.options),a({success:!0});break;case"stopAudioCapture":await D(t.tab.id),a({success:!0});break;case"checkTabStatus":const d=c.get(t.tab.id)||!1;a({success:!0,isActive:d});break;case"exportSubtitles":const b=await q(e.subtitles,e.format);a({success:!0,data:b});break;case"testAudio":const M=await U();a({success:!0,result:M});break;default:a({success:!1,error:"Unknown action"})}}catch(o){console.error("Error handling message:",o),a({success:!1,error:o.message})}})(),!0));async function l(){return(await chrome.storage.local.get("settings")).settings||p}async function x(e){await chrome.storage.local.set({settings:e});const t=await chrome.tabs.query({});for(const a of t)try{await chrome.tabs.sendMessage(a.id,{action:"settingsUpdated",settings:e})}catch{}}async function S(e,t,a){const r=(await l()).translationEngines.filter(n=>n.enabled).sort((n,s)=>n.priority-s.priority);for(const n of r)try{console.log(`Attempting translation with ${n.name}...`);const s=await v(n.name,e,t,a);if(s)return console.log(`Translation successful with ${n.name}`),s}catch(s){console.error(`Translation failed with ${n.name}:`,s)}throw new Error("All translation engines failed")}async function v(e,t,a,o){switch(a==="auto"&&(a=await y(t)),e){case"google":return await A(t,a,o);case"libretranslate":return await $(t,a,o);case"mymemory":return await k(t,a,o);case"microsoft":return await C();default:throw new Error(`Unsupported engine: ${e}`)}}async function A(e,t,a){const o=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${t}&tl=${a}&dt=t&q=${encodeURIComponent(e)}`,r=await fetch(o);if(!r.ok)throw new Error("Google Translate request failed");return(await r.json())[0].map(d=>d[0]).join("")}async function $(e,t,a){const r=await fetch("https://libretranslate.de/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({q:e,source:t==="auto"?"auto":t,target:a,format:"text"})});if(!r.ok)throw new Error("LibreTranslate request failed");return(await r.json()).translatedText}async function k(e,t,a){const o=`${t}|${a}`,r=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(e)}&langpair=${o}`,n=await fetch(r);if(!n.ok)throw new Error("MyMemory request failed");const s=await n.json();if(s.responseStatus===200)return s.responseData.translatedText;throw new Error("MyMemory translation failed")}async function C(e,t,a){throw new Error("Microsoft Translator requires API key configuration")}async function y(e){try{const t=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=t&q=${encodeURIComponent(e.substring(0,200))}`,a=await fetch(t);return a.ok&&(await a.json())[2]||"en"}catch(t){return console.error("Language detection failed:",t),"en"}}async function E(e,t){return await l(),console.log("Processing audio data..."),new Promise(a=>{setTimeout(()=>{a("Sample transcription from audio")},500)})}async function L(e,t){console.log("Starting audio capture for tab:",e);const a=await l();u.set(e,{active:!0,method:a.audioCaptureMethod,options:t})}async function D(e){console.log("Stopping audio capture for tab:",e);const t=u.get(e);t&&(t.active=!1,u.delete(e))}async function U(){return{success:!0,message:"Audio capture is available",capabilities:{webAudio:!0,mediaRecorder:typeof MediaRecorder<"u",audioContext:typeof AudioContext<"u"}}}async function q(e,t){switch(t){case"srt":return f(e);case"txt":return F(e);case"docx":return j(e);default:return f(e)}}function f(e){let t="";return e.forEach((a,o)=>{t+=`${o+1}
`,t+=`${m(a.startTime)} --> ${m(a.endTime)}
`,t+=`${a.text}

`}),t}function F(e){return e.map(t=>`[${w(t.startTime)}] ${t.text}`).join(`
`)}function j(e){let t=`Video Translation Export

`;return e.forEach(a=>{t+=`${w(a.startTime)} - ${a.text}
`}),t}function m(e){const t=Math.floor(e/3600),a=Math.floor(e%3600/60),o=Math.floor(e%60),r=Math.floor(e%1*1e3);return`${i(t,2)}:${i(a,2)}:${i(o,2)},${i(r,3)}`}function w(e){const t=Math.floor(e/3600),a=Math.floor(e%3600/60),o=Math.floor(e%60);return t>0?`${i(t,2)}:${i(a,2)}:${i(o,2)}`:`${i(a,2)}:${i(o,2)}`}function i(e,t){let a=e.toString();for(;a.length<t;)a="0"+a;return a}chrome.tabs.onRemoved.addListener(e=>{c.delete(e),u.delete(e),console.log("Cleaned up resources for closed tab:",e)});chrome.runtime.onUpdateAvailable.addListener(e=>{console.log("Update available:",e.version),l().autoUpdate&&chrome.runtime.reload()});console.log("Video Translator Extension background service worker initialized");
